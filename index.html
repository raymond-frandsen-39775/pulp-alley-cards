<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pulp Alley Fortune Card Lookup</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link rel="stylesheet" href="style.css"></head>
<body>
  <div class="wrap">
    <h1>Pulp Alley Fortune Card Lookup</h1>
    <div class="bar">
      <input id="q" type="search" placeholder="Search by ID or Name..." />
      <button id="btnSearch" type="button">Search</button>
    </div>
    <div id="results" class="cards"></div>
  </div>

  <!-- Sticky hand header + grid -->
  <div class="handHeader">
    <div class="handTitle">Hand: <span id="handCount">0</span></div>
    <div class="handControls">
      <button id="btnClearHand" type="button">Clear Hand</button>
    </div>
  </div>
  <div id="hand" class="handGrid"></div>

  <!-- Confirm modal -->
  <div id="confirm" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modalBox">
      <h3 id="confirmTitle" class="modalTitle">Remove card?</h3>
      <p class="modalMsg">This card will be removed from your hand.</p>
      <div class="modalBtns">
        <button id="confirmYes" class="btnDanger" type="button">Remove</button>
        <button id="confirmNo" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyZgs9DSPDUnbE63xiwhTefRqp20bpbSaD3illB_060SlDtmlYyjovgYecKBHIEjnRI0g/exec';

    // ===== JSONP helper (for CORS-free Apps Script calls) =====
    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        window[cb] = (data) => { resolve(data); delete window[cb]; s.remove(); };
        s.onerror = () => { reject(new Error('JSONP request failed')); delete window[cb]; s.remove(); };
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        document.body.appendChild(s);
      });
    }

    // ===== Inline SVG Icon Set (includes enamel coin variants) =====
    function iconSVG(name){
      const key = String(name||'').trim().toLowerCase();
      const uid = Math.random().toString(36).slice(2, 8); // unique per call

      switch (key) {
        case 'gear':
          return '<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g fill="currentColor">'
               + '<path d="M28 6h8l2 6 6 2 6-2 4 7-5 4 1 6 5 4-4 7-6-2-6 2-2 6h-8l-2-6-6-2-6 2-4-7 5-4-1-6-5-4 4-7 6 2 6-2 2-6z"/>'
               + '<circle cx="32" cy="32" r="10" fill="#fff" fill-opacity=".15"/></g></svg>';

        case 'star':
          return '<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M32 6l7.5 15.2 16.8 2.4-12.1 11.8 2.9 16.7L32 44.6 16.9 52.9l2.9-16.7L7.7 23.6 24.5 21z"/></svg>';

        case 'skull':
          return '<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">'
               + '<path d="M32 10c9 0 16 6.8 16 15.2 0 5.7-3 8.6-6.8 10.3V40H22.8v-4.5C19 34 16 31 16 25.2 16 16.8 23 10 32 10z" fill="currentColor"/>'
               + '<ellipse cx="26" cy="26" rx="3.5" ry="4.5" fill="#fff" fill-opacity=".1"/>'
               + '<ellipse cx="38" cy="26" rx="3.5" ry="4.5" fill="#fff" fill-opacity=".1"/>'
               + '<path d="M28 30l-2.2 3.2h4.4zM24 36h16v3H24z" fill="#fff" fill-opacity=".15"/></svg>';

        case 'bolt':
          return '<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M38 6 14 36h14l-2 22 26-32H38z"/></svg>';

        case 'book':
          return '<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">'
               + '<path d="M10 14c8-3 12-3 20 0v36c-8-3-12-3-20 0V14z" fill="currentColor"/>'
               + '<path d="M54 14c-8-3-12-3-20 0v36c8-3 12-3 20 0V14z" fill="currentColor"/>'
               + '<path d="M30 50c-6-2-10-2-16 0M50 50c-6-2-10-2-16 0" stroke="#fff" stroke-width="2" opacity=".25" fill="none"/></svg>';

        /* “Coin” enamel styles for right badge */
        case 'glass': {
          const gBronze = `gBronzeMag_${uid}`, gEnamel = `gEnamelMag_${uid}`;
          return ''+
            '<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">'+
            '  <defs>'+
            `    <radialGradient id="${gBronze}" cx="30%" cy="25%" r="80%"><stop offset="0%" stop-color="#e7bf97"/><stop offset="50%" stop-color="#b68459"/><stop offset="100%" stop-color="#744f33"/></radialGradient>`+
            `    <radialGradient id="${gEnamel}" cx="35%" cy="30%" r="75%"><stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#f4efe6"/></radialGradient>`+
            '  </defs>'+
            `  <circle cx="32" cy="32" r="31" fill="url(#${gBronze})" />`+
            `  <circle cx="32" cy="32" r="29" fill="url(#${gEnamel})" stroke="#c1b092" stroke-width="1"/>`+
            '  <g stroke="#3c2a1a" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none">'+
            '    <circle cx="28" cy="28" r="10" />'+
            '    <line x1="35" y1="35" x2="46" y2="46" />'+
            '  </g>'+
            '</svg>';
        }

        case 'lock': {
          const gBronze = `gBronzeLock_${uid}`, gEnamel = `gEnamelLock_${uid}`;
          return ''+
            '<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">'+
            '  <defs>'+
            `    <radialGradient id="${gBronze}" cx="30%" cy="25%" r="80%"><stop offset="0%" stop-color="#e7bf97"/><stop offset="50%" stop-color="#b68459"/><stop offset="100%" stop-color="#744f33"/></radialGradient>`+
            `    <radialGradient id="${gEnamel}" cx="35%" cy="30%" r="75%"><stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#f4efe6"/></radialGradient>`+
            '  </defs>'+
            `  <circle cx="32" cy="32" r="31" fill="url(#${gBronze})" />`+
            `  <circle cx="32" cy="32" r="29" fill="url(#${gEnamel})" stroke="#c1b092" stroke-width="1"/>`+
            '  <g stroke="#3c2a1a" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none">'+
            '    <path d="M24 30 v-6 a8 8 0 0 1 16 0 v6" />'+
            '    <rect x="22" y="30" width="20" height="16" rx="2" ry="2" fill="#3c2a1a" />'+
            '    <circle cx="32" cy="38" r="2" fill="#f4efe6" stroke="none"/>'+
            '    <line x1="32" y1="40" x2="32" y2="44" stroke="#f4efe6" stroke-width="2"/>'+
            '  </g>'+
            '</svg>';
        }

        default: return '';
      }
    }

    // ===== Right badge renderer — supports data-URL images or keyword icons =====
    function renderIconInline(storyIcon){
      const s = String(storyIcon||'').trim();
      if (!s) return '<div class="badge right">'+iconSVG('lock')+'</div>'; // default lock

      // If the sheet stores a data URL image, show it
      if (s.startsWith('data:image')) {
        return '<div class="badge right"><img alt="" src="'+s+'" style="width:100%;height:100%;object-fit:contain"></div>';
      }

      // Otherwise map common names to your inline SVG set
      const key = s.toLowerCase();
      const known = ['lock','glass','gear','star','skull','bolt','book'];
      if (known.includes(key)) {
        return '<div class="badge right">'+iconSVG(key)+'</div>';
      }

      // Fallback: show first letter(s)
      return '<div class="badge right" title="'+escapeAttr(s)+'"'
           + ' style="font-weight:900;font-size:14px;color:#3c2a1a;">'
           + escapeHtml(s.slice(0,2).toUpperCase())
           + '</div>';
    }

    // ===== Corner ornament SVG =====
    function ornSvg(){
      return '<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">'
           + '<path fill="#4c2b16" d="M0,0 L64,0 L64,8 C44,8 20,24 8,40 L0,40 Z" opacity=".85"/></svg>';
    }

    // ===== Divider SVG with three skull tiles =====
    function skullDividerSepia(){
      return '<svg viewBox="0 0 300 36" xmlns="http://www.w3.org/2000/svg">'
           + '<g stroke="#3c2a1a" stroke-width="2" stroke-linecap="round" fill="none">'
           + '<path d="M8 18 H95"/><path d="M205 18 H292"/></g>'
           + '<rect x="110" y="6" width="24" height="24" fill="#2b1a10" stroke="#3c2a1a"/>'
           + '<rect x="138" y="6" width="24" height="24" fill="#2b1a10" stroke="#3c2a1a"/>'
           + '<rect x="166" y="6" width="24" height="24" fill="#2b1a10" stroke="#3c2a1a"/>'
           + '<defs><g id="s">'
           + '<path d="M12,5 c5,0 9,3.5 9,8 c0,3 -1.5 4.5 -3.5 5.4 v2.2 h-11 v-2.2 C4.5,17.5 3,16 3,13 C3,8.5 7,5 12,5 z" fill="#f7f2e3" stroke="#3c2a1a" stroke-width="0.75"/>'
           + '<ellipse cx="9" cy="12" rx="2" ry="2.8" fill="#3c2a1a"/>'
           + '<ellipse cx="15" cy="12" rx="2" ry="2.8" fill="#3c2a1a"/>'
           + '<path d="M12 14 l-1.5 2.2 h3 z" fill="#3c2a1a"/>'
           + '<rect x="8" y="19.2" width="8" height="3.2" rx="0.8" fill="#3c2a1a"/></g></defs>'
           + '<use href="#s" x="110" y="6"/><use href="#s" x="138" y="6"/><use href="#s" x="166" y="6"/></svg>';
    }

    // ===== Text helpers =====
    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
    function nl2br(s){ return String(s).replace(/\r?\n/g,'<br>'); }

    // ===== ID → Object map =====
    let idToObj = {};

    // ===== Card HTML (exact visual parity with Google version) =====
    function cardHTML(o, opts){
      opts = opts || {};
      var name = o.Name || 'Untitled',
          play = o.Play || '',
          effect = o.Effect || '',
          flavor = o.Flavor || '',
          skills = o.Skills || '',
          id = o.ID || '',
          cardLimit = o.CardLimit || '',
          chall = o.ChallengeValue || '',
          storyIcon = o.StoryIcon || '';

      var html = '<div class="card" data-id="'+escapeAttr(id)+'">'
        + '<div class="corner tl">'+ornSvg()+'</div>'
        + '<div class="corner tr">'+ornSvg()+'</div>'
        + '<div class="corner br">'+ornSvg()+'</div>'
        + '<div class="corner bl">'+ornSvg()+'</div>';

      // "X" remove button when rendering in the Hand
      if (opts.isHand) {
        const uidAttr = opts.uid ? ' data-uid="'+escapeAttr(opts.uid)+'"' : '';
        html += '<button class="removeBtn"'+uidAttr+' data-id="'+escapeAttr(id)+'" title="Remove from hand">×</button>';
      }

      if (opts.showAdd)
        html += '<div class="actions"><button class="btn-add" data-id="'+escapeAttr(id)+'">+ Add to hand</button></div>';

      html += '<div class="title">'+escapeHtml(name)+'</div>';

      if (play) {
        const normalizedPlay = String(play).trim().toLowerCase();
        const mustPlay = normalizedPlay === 'you must play immediately.';
        const playStyle  = mustPlay ? 'color:#a00;font-weight:900;' : '';
        const labelStyle = mustPlay ? 'color:#a00;' : '';
        html += '<div class="row" style="'+playStyle+'"><span class="label" style="'+labelStyle+'">Play:</span> '+nl2br(escapeHtml(play))+'</div>';
      }
      if (effect)
        html += '<div class="row"><span class="label">Effect:</span> '+nl2br(escapeHtml(effect))+'</div>';

      if (flavor) {
        let f = String(flavor).trim();
        if (!/^["“].*["”]$/.test(f)) f = '"'+f+'"';
        html += '<div class="flavor">'+escapeHtml(f)+'</div>';
      }

      html += '<div class="divider">'+skullDividerSepia()+'</div>';
      html += '<div class="challengeHdr">Challenge</div>';

      if (skills)
        html += '<div class="skills">'+escapeHtml(skills)+'</div>';

      html += '<div class="badge left">'+(chall ? escapeHtml(chall) : '—')+'</div>';
      html += renderIconInline(storyIcon); // right badge
      html += '<div class="footer">#'+escapeHtml(id)+'/'+escapeHtml(cardLimit)+' • Pulp Alley © 2025</div>'
           +  '</div>';

      return html;
    }

    // ===== Render results payload =====
    function render(payload){
      const headers = payload.headers||[], rows = payload.rows||[];
      const resultsEl = document.getElementById('results');
      if(!rows.length){ resultsEl.innerHTML='<p>No cards found.</p>'; return; }
      const objs = rows.map(r => { const o = {}; headers.forEach((h,i)=> o[h]=r[i]); return o; });
      idToObj = {}; objs.forEach(o => { if(o && o.ID!=null) idToObj[o.ID]=o; });
      resultsEl.innerHTML = objs.map(o => cardHTML(o,{showAdd:true})).join('');
      // wire add buttons
      resultsEl.querySelectorAll('.btn-add').forEach(btn => {
        btn.addEventListener('click', () => addToHand(btn.getAttribute('data-id')));
      });
    }

    // ===== Live search via Apps Script JSONP =====
    async function doSearch(page = 1){
      const q = document.getElementById('q').value.trim();
      const res = document.getElementById('results');

      if (!q) { res.innerHTML = '<p>Please enter a search term.</p>'; return; }
      res.innerHTML = '<p><em>Searching…</em></p>';

      try {
        const url = GAS_URL + '?mode=json&q=' + encodeURIComponent(q) + '&page=' + page + '&_=' + Date.now();
        const payload = await jsonp(url);
        // Expected shape: {headers:[...], rows:[...]}
        if (!Array.isArray(payload.headers) || !Array.isArray(payload.rows)) {
          const list = Array.isArray(payload && payload.data) ? payload.data : [];
          const headers = list.length ? Object.keys(list[0]) : [];
          const rows = list.map(o => headers.map(h => o[h] ?? ''));
          render({ headers, rows });
        } else {
          render(payload);
        }
      } catch (e) {
        console.error(e);
        res.innerHTML = '<p style="color:#900;">Search failed: ' + escapeHtml(e.message) + '</p>';
      }
    }

    // ===== Hand management =====
    const handEl = document.getElementById('hand');
    const handCountEl = document.getElementById('handCount');

    function addToHand(id){
      const o = idToObj[id];
      if(!o) return;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHTML(o, { isHand:true, uid:String(Math.random()).slice(2) });
      const card = wrapper.firstElementChild;
      handEl.appendChild(card);
      updateHandCount();

      // wire remove button for this card
      const rm = card.querySelector('.removeBtn');
      if (rm) rm.addEventListener('click', () => confirmRemove(card));
    }

    function updateHandCount(){
      handCountEl.textContent = handEl.querySelectorAll('.card').length;
    }

    // ===== Confirm modal for removals =====
    const modal = document.getElementById('confirm');
    const btnYes = document.getElementById('confirmYes');
    const btnNo = document.getElementById('confirmNo');
    let pendingRemove = null;

    function confirmRemove(card){
      pendingRemove = card;
      modal.classList.add('show');
      btnYes.onclick = () => { if(pendingRemove){ pendingRemove.remove(); updateHandCount(); } closeModal(); };
      btnNo.onclick  = closeModal;
      modal.addEventListener('click', (e)=> { if(e.target===modal) closeModal(); }, { once:true });
      window.addEventListener('keydown', escClose, { once:true });
    }
    function escClose(e){ if(e.key==='Escape') closeModal(); }
    function closeModal(){ modal.classList.remove('show'); pendingRemove=null; }

    // ===== Clear hand =====
    document.getElementById('btnClearHand').addEventListener('click', () => {
      if(!handEl.firstChild) return;
      // Reuse modal to confirm
      document.getElementById('confirmTitle').textContent = 'Clear entire hand?';
      document.querySelector('#confirm .modalMsg').textContent = 'All cards will be removed from your hand.';
      modal.classList.add('show');
      btnYes.onclick = () => { handEl.innerHTML=''; updateHandCount(); restoreConfirmText(); closeModal(); };
      btnNo.onclick  = () => { restoreConfirmText(); closeModal(); };
      modal.addEventListener('click', (e)=> { if(e.target===modal){ restoreConfirmText(); closeModal(); } }, { once:true });
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ restoreConfirmText(); closeModal(); } }, { once:true });
      function restoreConfirmText(){
        document.getElementById('confirmTitle').textContent = 'Remove card?';
        document.querySelector('#confirm .modalMsg').textContent = 'This card will be removed from your hand.';
      }
    });

    // ===== Wire up search =====
    document.getElementById('btnSearch').addEventListener('click', () => doSearch(1));
    document.getElementById('q').addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(1); });
  </script>
</body>
</html>
