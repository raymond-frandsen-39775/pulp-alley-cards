<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pulp Alley Card Lookup</title>

  <!-- Favicon as data URI to avoid 404 -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <style>
    :root{
      --bg:#d6c5a0;
      --paper:#f6edd9;
      --ink:#3b2d12;
      --line:#b9a37f;
      --soft:#fff8ea;
      --muted:#6a5832;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Georgia, "Times New Roman", serif;
      background: var(--bg);
      color: var(--ink);
    }

    .wrap{
      max-width:1100px;
      margin:24px auto 96px;
      padding:0 16px;
      text-align:center;
    }

    h1{
      font-family:"Copperplate",Georgia,serif;
      font-size:26px;
      margin:0 0 8px;
      letter-spacing:.5px;
    }
    .sub{
      margin:0 0 12px;
      font-size:14px;
      color:var(--muted);
    }

    .bar{
      display:flex;
      gap:8px;
      justify-content:center;
      align-items:center;
      margin:12px 0 16px;
      flex-wrap:wrap;
    }

    input[type="search"]{
      width:60%;
      min-width:280px;
      padding:10px 12px;
      font-size:16px;
      border:1px solid var(--line);
      border-radius:6px;
      background:#fff;
    }

    button{
      padding:10px 14px;
      font-size:16px;
      cursor:pointer;
      border:1px solid var(--line);
      border-radius:6px;
      background: var(--paper);
    }

    /* Results shell */
    #results{
      text-align:left;
      background: var(--soft);
      padding:12px;
      border-radius:8px;
      max-width:1000px;
      margin:16px auto 0;
      border:1px solid rgba(0,0,0,.1);
      min-height:64px;
    }

    /* Card list mirroring original GAS layout (paper card) */
    .card{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:12px;
      padding:14px 14px 12px;
      margin:12px 0;
      box-shadow:0 2px 4px rgba(0,0,0,.12);
    }
    .cardHead{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:8px;
    }
    .iconWrap{
      width:48px; height:48px; flex:0 0 48px;
      border-radius:50%;
      background:#f2e7ce;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; border:1px solid #d4c4a5;
    }
    .iconWrap img{
      max-width:100%; max-height:100%; display:block;
      object-fit:contain;
    }
    .titleBox{
      flex:1 1 auto;
    }
    .title{
      margin:0;
      font-size:18px;
      line-height:1.2;
    }
    .meta{
      font-size:13px;
      opacity:.85;
    }

    .fields{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px 16px;
      margin-top:6px;
    }
    .field{
      background:#fff;
      border:1px solid rgba(0,0,0,.05);
      border-radius:8px;
      padding:8px 10px;
    }
    .label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .val{ font-size:14px; white-space:pre-wrap; }

    /* Full-width rows for long text */
    .field.play,
    .field.effect,
    .field.flavor{
      grid-column: 1 / -1;
    }
    .flavor .val{ font-style:italic; }

    /* “Hand” area (optional) */
    #hand{
      max-width:1000px;
      margin:20px auto 0;
      padding:12px;
      background:rgba(246,237,217,.9);
      border:1px dashed var(--line);
      border-radius:10px;
    }

    /* Top-left copyright */
    .copyright{
      position: fixed;
      top: 8px;
      left: 12px;
      font-size: 12px;
      color: var(--ink);
      background: rgba(255,255,255,.6);
      padding: 6px 10px;
      border-radius: 4px;
      line-height: 1.4;
      z-index: 1000;
      text-align: left;
      box-shadow:0 2px 4px rgba(0,0,0,.25);
    }

    /* Responsive */
    @media (max-width: 720px){
      .fields{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <!-- Copyright overlay -->
  <div class="copyright">
    App Copyright 2025 - Ray Frandsen<br>
    Cards Copyright 2025 - Pulp Alley
  </div>

  <div class="wrap">
    <h1>Pulp Alley Card Lookup</h1>
    <p class="sub">Search by ID, name, skills, or effect text.</p>

    <div class="bar">
      <input id="q" type="search" placeholder="Search cards…" />
      <button id="btnSearch" type="button">Search</button>
    </div>

    <div id="results">Type a query and click Search…</div>

    <!-- Optional “hand” container -->
    <div id="hand" hidden>
      <strong>Your Hand</strong>
      <div id="handItems"></div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    // Replace with your current /exec URL when you redeploy
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxzfKR_CuPgnn6XNWympqPeMWWcG-zBj7XMPLjFjag5vBtbpgW7gUfpV3ON-vYlUas9lg/exec';

    // ========= UTIL: JSONP loader (bypasses CORS) =========
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');

        window[cb] = (data) => {
          resolve(data);
          delete window[cb];
          s.remove();
        };

        s.onerror = () => {
          console.error('JSONP failed for', s.src);
          reject(new Error('JSONP request failed'));
          delete window[cb];
          s.remove();
        };

        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        document.body.appendChild(s);
      });
    }

    // ========= GLOBALS =========
    let idToObj = {};

    // ========= RENDER =========
    // Expects: payload = { headers: [...], rows: [...] }
    function render(payload){
      const headers = payload.headers || [];
      const rows = payload.rows || [];
      const resultsEl = document.getElementById('results');

      if (!rows.length) {
        resultsEl.innerHTML = '<p>No cards found.</p>';
        return;
      }

      // Convert rows -> objects
      const objs = rows.map(r => {
        const o = {};
        headers.forEach((h,i) => o[h] = r[i]);
        return o;
      });

      // Reindex by ID
      idToObj = {};
      objs.forEach(o => { if (o.ID != null && o.ID !== '') idToObj[o.ID] = o; });

      // Render cards in original field order
      resultsEl.innerHTML = objs.map(o => cardHTML(o, { showAdd: true })).join('');
    }

    // ========= CARD TEMPLATE (mirrors original field order) =========
    function cardHTML(o, opts = {}) {
      const id     = safe(o.ID);
      const name   = safe(o.Name);
      const play   = safe(o.Play);
      const effect = safe(o.Effect);
      const flavor = safe(o.Flavor);
      const skills = safe(o.Skills);
      const chal   = safe(o.ChallengeValue);
      const limit  = safe(o.CardLimit);
      const icon   = o.StoryIcon || '';

      // If StoryIcon is a data URL, show it; if it’s a filename, show initials as placeholder
      const iconHTML = icon && String(icon).startsWith('data:image')
        ? `<img alt="icon" src="${icon}">`
        : `<span style="font-size:12px; color:#7a6b46;">${safe(shortIcon_(icon))}</span>`;

      const addBtn = opts.showAdd
        ? `<button type="button" onclick="addToHandById('${String(id).replace(/'/g, "\\'")}')">Add</button>`
        : '';

      return `
        <div class="card">
          <div class="cardHead">
            <div class="iconWrap">${iconHTML}</div>
            <div class="titleBox">
              <h3 class="title">${name || `(Card ${id||''})`}</h3>
              <div class="meta">${id ? `ID: ${id}` : ''}${limit ? ` &middot; Limit: ${limit}` : ''}</div>
            </div>
            ${addBtn}
          </div>

          <div class="fields">
            ${play   ? fieldHTML('Play',    play,   'play')   : ''}
            ${effect ? fieldHTML('Effect',  effect, 'effect') : ''}
            ${flavor ? fieldHTML('Flavor',  flavor, 'flavor') : ''}
            ${skills ? fieldHTML('Skills',  skills)           : ''}
            ${chal   ? fieldHTML('Challenge Value', chal)     : ''}
            ${limit  ? fieldHTML('Card Limit', limit)         : ''}
          </div>
        </div>
      `;
    }

    function fieldHTML(label, value, cls=''){
      return `
        <div class="field ${cls}">
          <span class="label">${escapeHTML(label)}</span>
          <div class="val">${escapeHTML(value)}</div>
        </div>`;
    }

    function shortIcon_(s){
      const t = String(s||'').trim();
      if (!t) return '';
      const base = t.split('/').pop().split('\\').pop().replace(/\.[a-z0-9]+$/i,'');
      return base.length > 10 ? base.slice(0,10)+'…' : base;
    }

    // ========= ADD TO HAND =========
    function addToHandById(id){
      const base = idToObj[id] ? { ...idToObj[id] } : { ID: id, Name: '(Unknown)' };
      const hand = document.getElementById('hand');
      const handItems = document.getElementById('handItems');
      hand.hidden = false;

      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="cardHead">
          <div class="titleBox">
            <h3 class="title">${escapeHTML(base.Name || base.Title || '(Unknown)')}</h3>
            <div class="meta">ID: ${escapeHTML(String(base.ID ?? ''))}</div>
          </div>
        </div>`;
      handItems.appendChild(div);
    }

    // ========= SEARCH (JSONP) =========
    async function doSearch(){
      const q = document.getElementById('q').value.trim();
      const results = document.getElementById('results');

      if (!q) {
        results.innerHTML = '<p>Please enter a search term.</p>';
        return;
      }

      results.innerHTML = '<p><em>Searching…</em></p>';

      try {
        const url = `${GAS_URL}?mode=json&q=${encodeURIComponent(q)}&page=1&_=${Date.now()}`;
        const payload = await jsonp(url); // JSONP bypasses CORS

        // Ensure shape {headers, rows}. If server returns {data:[...]}, adapt here:
        if (!Array.isArray(payload.headers) || !Array.isArray(payload.rows)) {
          const list = Array.isArray(payload?.data) ? payload.data : [];
          const headers = list.length ? Object.keys(list[0]) : [];
          const rows = list.map(obj => headers.map(h => obj[h] ?? ''));
          render({ headers, rows });
        } else {
          render(payload);
        }
      } catch (err) {
        console.error(err);
        results.innerHTML = `<p style="color:#900;">Search failed: ${escapeHTML(err.message)}</p>`;
      }
    }

    // Wire up
    document.getElementById('btnSearch').onclick = doSearch;
    document.getElementById('q').addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

    // ========= HELPERS =========
    function escapeHTML(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function safe(v){ return v == null ? '' : String(v); }
  </script>
</body>
</html>
