<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pulp Alley Card Lookup</title>

  <!-- Favicon as data URI to avoid 404 -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <style>
    :root{
      --bg:#d6c5a0;
      --paper:#f6edd9;
      --ink:#4b3a1a;
      --line:#b9a37f;
      --soft:#fff8ea;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Georgia, "Times New Roman", serif;
      background: var(--bg);
      color: var(--ink);
    }

    .wrap{
      max-width:1100px;
      margin:24px auto 96px;
      padding:0 16px;
      text-align:center;
    }

    h1{
      font-family:"Copperplate",Georgia,serif;
      font-size:26px;
      margin:0 0 12px;
    }

    .bar{
      display:flex;
      gap:8px;
      justify-content:center;
      align-items:center;
      margin:12px 0 16px;
      flex-wrap:wrap;
    }

    input[type="search"]{
      width:60%;
      min-width:280px;
      padding:10px 12px;
      font-size:16px;
      border:1px solid var(--line);
      border-radius:6px;
      background:#fff;
    }

    button{
      padding:10px 14px;
      font-size:16px;
      cursor:pointer;
      border:1px solid var(--line);
      border-radius:6px;
      background: var(--paper);
    }

    /* Results area */
    #results{
      text-align:left;
      background: var(--soft);
      padding:12px;
      border-radius:8px;
      max-width:1000px;
      margin:16px auto 0;
      overflow:auto;
      min-height:64px;
      border:1px solid rgba(0,0,0,.1);
    }

    /* Simple “card” UI for each result */
    .card{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:10px;
      padding:12px;
      margin:10px 0;
      box-shadow:0 2px 4px rgba(0,0,0,.12);
    }
    .card h3{
      margin:0 0 6px;
      font-size:18px;
    }
    .meta{
      font-size:13px;
      opacity:.85;
    }

    /* “Hand” area (optional) */
    #hand{
      max-width:1000px;
      margin:20px auto 0;
      padding:12px;
      background:rgba(246,237,217,.9); /* fixed .9 */
      border:1px dashed var(--line);
      border-radius:10px;
    }

    /* Top-left copyright */
    .copyright{
      position: fixed;
      top: 8px;
      left: 12px;
      font-size: 12px;
      color: var(--ink);
      background: rgba(255,255,255,.6);
      padding: 6px 10px;
      border-radius: 4px;
      line-height: 1.4;
      z-index: 1000;
      text-align: left;
      box-shadow:0 2px 4px rgba(0,0,0,.25); /* fixed .25 */
    }
  </style>
</head>
<body>
  <!-- Copyright overlay -->
  <div class="copyright">
    App Copyright 2025 - Ray Frandsen<br>
    Cards Copyright 2025 - Pulp Alley
  </div>

  <div class="wrap">
    <h1>Pulp Alley Card Lookup</h1>

    <div class="bar">
      <input id="q" type="search" placeholder="Search cards…" />
      <button id="btnSearch" type="button">Search</button>
    </div>

    <div id="results">Type a query and click Search…</div>

    <!-- Optional “hand” container to show items added via Add buttons -->
    <div id="hand" hidden>
      <strong>Your Hand</strong>
      <div id="handItems"></div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    // Replace with your current /exec URL when you redeploy
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxzfKR_CuPgnn6XNWympqPeMWWcG-zBj7XMPLjFjag5vBtbpgW7gUfpV3ON-vYlUas9lg/exec';

    // ========= UTIL: JSONP loader (bypasses CORS) =========
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');

        window[cb] = (data) => {
          resolve(data);
          delete window[cb];
          s.remove();
        };

        s.onerror = () => {
          reject(new Error('JSONP request failed'));
          delete window[cb];
          s.remove();
        };

        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        document.body.appendChild(s);
      });
    }

    // ========= GLOBALS =========
    // Global lookup of ID -> object (used by addToHandById)
    let idToObj = {};

    // ========= RENDER =========
    // Expects: payload = { headers: [...], rows: [...] }
    function render(payload){
      const headers = payload.headers || [];
      const rows = payload.rows || [];
      const resultsEl = document.getElementById('results');

      if (!rows.length) {
        resultsEl.innerHTML = '<p>No cards found.</p>';
        return;
      }

      // Turn table back into list of objects per row
      const objs = rows.map(r => {
        const o = {};
        headers.forEach((h,i) => o[h] = r[i]);
        return o;
      });

      // Rebuild ID map
      idToObj = {};
      objs.forEach(o => {
        if (o.ID != null && o.ID !== '') idToObj[o.ID] = o;
      });

      resultsEl.innerHTML = objs.map(o => cardHTML(o, { showAdd: true })).join('');
    }

    // ========= MINIMAL CARD TEMPLATE =========
    function cardHTML(o, opts = {}) {
      const title = o.Name || o.Title || o.Card || `Card ${o.ID ?? ''}`;
      const subtitle = o.Type || o.Category || '';
      const id = o.ID ?? '';

      const addBtn = opts.showAdd
        ? `<button type="button" onclick="addToHandById('${String(id).replace(/'/g, "\\'")}')">Add</button>`
        : '';

      return `
        <div class="card">
          <h3>${escapeHTML(title)}</h3>
          <div class="meta">
            ${id ? `ID: ${escapeHTML(String(id))}` : ''}${subtitle ? ` &middot; ${escapeHTML(subtitle)}` : ''}
          </div>
          <div class="actions" style="margin-top:6px;">${addBtn}</div>
        </div>
      `;
    }

    // ========= ADD TO HAND =========
    function addToHandById(id){
      // Create a copy or a fallback object
      const base = idToObj[id] ? { ...idToObj[id] } : { ID: id, Name: '(Unknown)' };

      const hand = document.getElementById('hand');
      const handItems = document.getElementById('handItems');
      hand.hidden = false;

      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <h3>${escapeHTML(base.Name || base.Title || '(Unknown)')}</h3>
        <div class="meta">ID: ${escapeHTML(String(base.ID ?? ''))}</div>
      `;
      handItems.appendChild(div);
    }

    // ========= SEARCH (JSONP) =========
    async function doSearch(){
      const q = document.getElementById('q').value.trim();
      const results = document.getElementById('results');

      if (!q) {
        results.innerHTML = '<p>Please enter a search term.</p>';
        return;
      }

      results.innerHTML = '<p><em>Searching…</em></p>';

      try {
        const url = `${GAS_URL}?mode=json&q=${encodeURIComponent(q)}&page=1&_=${Date.now()}`;
        const payload = await jsonp(url); // JSONP to bypass CORS

        // Ensure shape {headers, rows}. If server returns {data:[...]}, adapt here:
        if (!Array.isArray(payload.headers) || !Array.isArray(payload.rows)) {
          const list = Array.isArray(payload?.data) ? payload.data : [];
          const headers = list.length ? Object.keys(list[0]) : [];
          const rows = list.map(obj => headers.map(h => obj[h] ?? ''));
          render({ headers, rows });
        } else {
          render(payload);
        }
      } catch (err) {
        console.error(err);
        results.innerHTML = `<p style="color:#900;">Search failed: ${escapeHTML(err.message)}</p>`;
      }
    }

    // Wire up button and Enter-to-search
    document.getElementById('btnSearch').onclick = doSearch;
    document.getElementById('q').addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

    // ========= HELPERS =========
    function escapeHTML(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
  </script>
</body>
</html>
